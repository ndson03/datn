<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Chatbot</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link rel="stylesheet" th:href="@{/css/navbar.css}">

    <link rel="stylesheet" th:href="@{/css/admin/admin-panel.css}">
    <link rel="stylesheet" th:href="@{/css/gemini.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- Thư viện Markdown-it & DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

</head>

<body>

<nav>
    <i class="fa fa-mortar-board"></i>
    <h1>Trường SICT - HaUI</h1>
    <ul>
        <li>
            <a><i class="fa fa-user-circle"></i>Admin</a>
            <ul class="dropdown">
                <li>
                    <form action="#" th:action="@{/logout}" method="POST">
                        <input type="submit" value="Đăng xuất"></input>
                    </form>
                </li>
            </ul>
        </li>
    </ul>
</nav>

<div class="vertical-navbar">
    <ul>
        <li><a th:href="@{/admin/adminPanel}"><i class="fa fa-home fa-navbar"></i><span>Trang chủ</span></a></li>
        <li><a th:href="@{/admin/courses}"><i class="fa fa-pencil fa-navbar"></i><span>Khóa học</span></a></li>
        <li><a th:href="@{/admin/students}"><i class="fa fa-user fa-navbar"></i><span>Sinh viên</span></a></li>
        <li><a th:href="@{/admin/teachers}"><i class="fa fa-user-secret fa-navbar"></i><span>Giảng viên</span></a></li>
        <li><a th:href="@{/admin/adminInfo}"><i class="fa fa-info-circle fa-navbar"></i><span>Thông tin</span></a></li>
        <li><a th:href="@{/gemini/qna}"><i class="fa fa-info-circle fa-navbar"></i><span>Chatbot</span></a></li>
    </ul>
</div>



<div class="content">

    <div class="chat-container">
        <div class="chat-box" id="chatBox">
            <!-- Chat messages sẽ được thêm vào đây -->
        </div>

        <div class="chat-input-container">
            <textarea id="questionInput" placeholder="Nhập câu hỏi" oninput="autoResize(this)" onkeydown="checkEnter(event)" autofocus></textarea>
            <i class="fas fa-arrow-up" id="sendIcon" onclick="askQuestion()"></i>
        </div>
    </div>


</div>


<script>
    // Khởi tạo Markdown-it parser
    const md = window.markdownit({ html: false, linkify: true, typographer: true });

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function askQuestion() {
        const input = document.getElementById('questionInput');
        const question = input.value.trim();
        if (!question) return;

        // 1) Hiển thị nội dung của user
        displayUserMessage(question);

        // 2) Tạo placeholder loading như 1 tin nhắn bot
        const chatBox = document.getElementById('chatBox');
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'bot-message loading-message';
        loadingDiv.innerHTML = '<i class="fa fa-spinner fa-spin loading"></i>Vui lòng chờ...';
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        // 3) Reset input
        input.value = '';
        autoResize(input);
        document.getElementById('sendIcon').style.pointerEvents = 'none'; // tạm disable click

        // 4) Gửi request
        fetch('/gemini/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        })
            .then(res => res.text())
            .then(data => {
                // Khi có dữ liệu, render markdown và replace nội dung placeholder
                const sanitized = DOMPurify.sanitize(md.render(data));
                loadingDiv.className = 'bot-message';       // chuyển thành bot-message bình thường
                loadingDiv.innerHTML = sanitized;

                // highlight code nếu có
                loadingDiv.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            })
            .catch(err => {
                loadingDiv.className = 'bot-message';
                loadingDiv.textContent = 'Có lỗi xảy ra. Vui lòng thử lại!';
            })
            .finally(() => {
                document.getElementById('sendIcon').style.pointerEvents = 'auto';
            });
    }


    function toggleLoading(isLoading) {
        document.getElementById('sendIcon').style.display = isLoading ? 'none' : 'inline-block';
        document.getElementById('loadingIcon').style.display = isLoading ? 'inline-block' : 'none';
    }

    function displayUserMessage(text) {
        const el = document.createElement('div');
        el.className = 'user-message';
        el.textContent = text;
        appendMessage(el);
    }

    function displayBotMessage(mdText) {
        const el = document.createElement('div');
        el.className = 'bot-message';
        // chuyển Markdown → HTML và sanitize
        const html = md.render(mdText);
        el.innerHTML = DOMPurify.sanitize(html);
        // sau el.innerHTML = DOMPurify.sanitize(html);
        el.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });

        appendMessage(el);
    }

    function appendMessage(el) {
        const box = document.getElementById('chatBox');
        box.appendChild(el);
        box.scrollTop = box.scrollHeight;
    }

    function checkEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            askQuestion();
        }
    }
</script>
</body>

</html>